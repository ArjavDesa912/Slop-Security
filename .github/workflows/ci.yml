name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # ============================================
  # Rust Core
  # ============================================
  rust-core:
    name: Rust Core
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: slop-core
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          targets: wasm32-unknown-unknown
      
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            slop-core/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('slop-core/Cargo.lock') }}
      
      - name: Check formatting
        run: cargo fmt --check
      
      - name: Clippy
        run: cargo clippy -- -D warnings
      
      - name: Run tests
        run: cargo test
      
      - name: Build WASM
        run: cargo build --target wasm32-unknown-unknown --release

  # ============================================
  # Node.js SDK
  # ============================================
  node-sdk:
    name: Node.js SDK
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: sdks/node
    
    strategy:
      matrix:
        node-version: [18, 20, 22]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
          cache-dependency-path: sdks/node/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Lint
        run: npm run lint || true
      
      - name: Test
        run: npm test || true

  # ============================================
  # Python SDK
  # ============================================
  python-sdk:
    name: Python SDK
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: sdks/python
    
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Lint with ruff
        run: ruff check slop/ || true
      
      - name: Type check with mypy
        run: mypy slop/ || true
      
      - name: Test with pytest
        run: pytest || true

  # ============================================
  # Vibe-Check CLI
  # ============================================
  vibe-check:
    name: Vibe-Check CLI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: vibe-check
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: vibe-check/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Test CLI
        run: node dist/cli.js --help

  # ============================================
  # Security Scan
  # ============================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [vibe-check]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - name: Install vibe-check
        run: |
          cd vibe-check
          npm ci
          npm run build
      
      - name: Run vibe-check on codebase
        run: |
          node vibe-check/dist/cli.js . --ci --fail-on critical --exclude "**/node_modules/**,**/dist/**,**/examples/**"
